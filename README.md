## Тестовое задание для Nexign Bootcamp

Проект разработан для эмуляции работы коммутатора и генерации отчетов о длительности звонков на основе CDR *(Call Data Record)* файлов. Проект включает в себя сервисы для генерации CDR файлов, агрегации данных и создания отчетов UDR *(Usage Data Report)*.

---

### Описание задач и решения

---

#### Задача 1: Генерация CDR файлов

*Необходимо разработать сервис, который будет эмулировать работу коммутатора и генерировать CDR файлы за тарифицируемый период (1 год).*  

Для решения поставленной задачи был написан класс `ServiceCDR`, который генерирует 12 экземпляров CDR файлов в формате .txt и помещает их в папку `cdr_2024`. Каждый такой файл содержит случайное количество записей (от 50 до 100). Генерация самих записей происходит следующим образом:  
1. Тип звонка генерируется при помощи класса `java.util.Random`
2. Номер телефона абонента выбирается случайным образом из списка всех абонентов в базе данных.  
3. Время начала звонка генерируется методом `generateRandomDate`, который создает случайную дату в пределах указанного месяца текущего года.  
4. Для времени окончания звонка генерируется случайное количество секунд в пределах одного часа, а затем это время прибавляется к времени начала звонка с использованием метода `plusSeconds`. 

Каждое время записывается в формате Unix time при помощи метода `getEpochSecond`. 

---

#### Задача 2: Генерация отчетов UDR

*На основе сгенерированных CDR файлов необходимо создать отчеты UDR, агрегирующие данные по каждому абоненту. Эти отчеты будут содержать информацию о длительности входящих и исходящих вызовов для каждого абонента.*  

В классе `ServiceUDR` сосредоточена основная логика решения поставленной задачи:

- **Метод generateUDR:**

    Принимает директорию с CDR файлами и директорию для сохранения UDR файлов, а также определяет период, за который нужно сгенерировать UDR файлы. Затем осуществляет обработку каждого CDR файла для указанного месяца, извлекая данные о звонках и агрегируя их для формирования UDR.  

- **Метод processCDRFile:**

    Сканирует каждую строку из CDR файла, анализирует ее содержимое и обновляет соответствующие поля объектов UDR.  

- **Метод createUDRFiles:**

    Создает отдельный файл UDR для каждого абонента в указанной директории после завершения обработки всех файлов для месяца.
    Использует объект `ObjectMapper` для сериализации данных в JSON формат.  

В результате выполнения программы формируется папка `records`, содержащая 12 подпапок, соответствующих каждому месяцу в году. Внутри этих подпапок располагаются файлы в формате *номер_месяц.json*, содержащие информацию о длительности входящих и исходящих звонков для каждого абонента.  

---

#### Реализация класса генератора  
Класс `ReportGenerator` состоит из трёх основных методов и  представляет инструмент для генерации отчетов о длительности звонков.  
- **Метод generateReport():**  

    Сканирует директорию `reports`, анализирует файлы UDR для каждого месяца и извлекает информацию о времени входящих и исходящих звонков для каждого абонента. Затем он суммирует это время для каждого абонента и сохраняет результаты в структуру данных `Map<String, String> totalCallTimes`, где ключом является номер телефона абонента, а значением - итоговое время звонков. Наконец вызывается метод `printReport(totalCallTimes)`, чтобы отобразить полученные данные в виде таблицы.  

    Пример вывода:
  
    ![alt text](https://github.com/polainam/bootcamp-nexign/blob/master/images/generate_report_example1.jpg)  

- **Метод generateReport(String msisdn):**  

    Находит файлы UDR для указанного абонента (msisdn) в каждом месяце года в директории `reports`. Обрабатывая каждый файл, он извлекает информацию о времени входящих и исходящих звонков для этого абонента, суммирует это время для каждого месяца и сохраняет результаты в `Map<String, String> totalCallTimes`, где ключом является номер месяца, а значением - итоговое время звонков. По завершении обработки файлов, метод выводит таблицу на консоль с помощью `printReport(msisdn, totalCallTimes)`.  

    Пример вывода:
  
    ![alt text](https://github.com/polainam/bootcamp-nexign/blob/master/images/generate_report_example2.jpg)  

- **Метод generateReport(String msisdn, int month):**  

    Генерирует отчет о длительности звонков для конкретного абонента за указанный месяц. Сначала он проверяет наличие директории для указанного месяца в директории `reports`. Затем он пытается найти файл UDR для данного абонента и месяца. Если файл существует, то извлекаются данные о времени входящих и исходящих звонков из этого файла, после чего вычисляется общее время звонков и также сохраняется в `totalCallTimes`. Если файл не найден, выводится сообщение о его отсутствии. Для вывода таблицы на консоль используется `printReport(msisdn, month, totalCallTimes)`.  

    Пример вывода:
  
    ![alt text](https://github.com/polainam/bootcamp-nexign/blob/master/images/generate_report_example3.jpg)

---   

### База данных  
Проект использует базу данных H2, работающую в памяти. Подключение к ней осуществляется через JDBC-URL: `jdbc:h2:mem:bootcamp-nexign`.

При каждом запуске приложения автоматически выполняется инициализация базы данных. Это происходит благодаря настройке `spring.sql.init.mode=always`, заставляющей Spring Boot выполнять скрипты инициализации при каждом запуске.

Инициализация включает выполнение SQL-скриптов *schema.sql* и *data.sql*, содержащих определения таблиц и начальные данные соответственно.

При запуске приложения создаются таблицы `abonents` и `calls`, а затем в них загружаются данные об абонентах и звонках из скриптов *data.sql*.   

---   

### Тесты   
- **Класс ServiceUDRTest:**   

    Этот класс тестирует функциональность класса *ServiceUDR*, который отвечает за генерацию файлов UDR. В тесте *testGenerateUDR()* вызывается метод *generateUDR()* для создания UDR файлов на основе тестовых CDR файлов, находящихся в директории `src/test/cdr_2024`. После этого происходит проверка наличия созданных файлов в директории `src/test/reports` и сравнение содержимого созданных файлов с ожидаемым.

- **Класс ParseDurationTest:**   

    Этот тест проверяет правильность парсинга временных данных из строки в формате `часы:минуты:секунды`. Метод *testParseDuration()* использует статический метод *parseDuration()* класса Parser для парсинга строки времени и сравнивает полученное значение с ожидаемым.

- **Класс FormatDurationTest:**   

    Этот тест проверяет правильность форматирования временных данных в строку в формате `часы:минуты:секунды`. Метод *testFormatDuration()* использует статический метод *formatDuration()* класса *Parser* для форматирования объекта *Duration* и сравнивает полученное значение с ожидаемым.

    ![alt text](https://github.com/polainam/bootcamp-nexign/blob/master/images/tests.jpg) 
